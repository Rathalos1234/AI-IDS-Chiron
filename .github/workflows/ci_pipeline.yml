name: AI-IDS Chiron CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main, CICD]
  schedule:
    - cron: "0 9 * * *"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PYTHONUNBUFFERED: "1"
  PYTHONDONTWRITEBYTECODE: "1"

jobs:
  fast:
    name: Lint + Unit (PR gate)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"
          cache-dependency-path: |
            AI-IDS/AI-IDS/requirements.txt
            AI-IDS/AI-IDS/requirements-dev.txt
      - name: Upgrade pip
        run: python -m pip install --upgrade pip wheel
      - name: Install deps (runtime + test/linters)
        run: pip install -r AI-IDS/AI-IDS/requirements.txt pytest ruff mypy
      - name: Make scripts executable
        run: chmod +x AI-IDS/AI-IDS/scripts/test_fast.sh AI-IDS/AI-IDS/scripts/test_full.sh
      - name: Run fast gate
        run: bash AI-IDS/AI-IDS/scripts/test_fast.sh
        env:
          LINT_STRICT: "1"

  full:
    name: Unit + Integration (+ perf)
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"
          cache-dependency-path: |
            AI-IDS/AI-IDS/requirements.txt
            AI-IDS/AI-IDS/requirements-dev.txt
      - name: Upgrade pip
        run: python -m pip install --upgrade pip wheel
      - name: Install deps
        run: pip install -r AI-IDS/AI-IDS/requirements.txt pytest ruff mypy
      - name: Make scripts executable
        run: chmod +x AI-IDS/AI-IDS/scripts/test_full.sh
      - name: Run full suite
        run: bash AI-IDS/AI-IDS/scripts/test_full.sh
      - name: Append perf snapshot to job summary
        if: always()
        run: |
          echo "### Perf snapshot (10k rows)" >> $GITHUB_STEP_SUMMARY
          if [ -f sprint_artifacts/pytest_perf.txt ]; then
            tail -n 50 sprint_artifacts/pytest_perf.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "No perf output found (skipped or failed)" >> $GITHUB_STEP_SUMMARY
          fi
      - name: Upload sprint artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sprint_artifacts
          path: sprint_artifacts/**
          if-no-files-found: ignore
